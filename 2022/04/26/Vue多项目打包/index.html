<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="referrer" content="no-referrer" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Star Sea">
    
    <title>
        
            Vue多项目打包 |
        
        StarSea
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/avatar.jpg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"www.starsea.club","root":"/","language":"zh-CN","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.jpg","favicon":"/images/avatar.jpg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"上次写博客，还是上一次"},"scroll":{"progress_bar":false,"percent":true}},"local_search":{"enable":true,"preload":false},"code_copy":{"enable":true,"style":"mac"},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"3.4.3"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 月前","year":"%s 年前"};
  </script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                StarSea
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">Vue多项目打包</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.jpg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Star Sea</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;2022-04-26 20:33:28
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/%E5%89%8D%E7%AB%AF/">前端</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/Vue/">Vue</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>2.2k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>9 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h2 id="导语"><a href="#导语" class="headerlink" title="导语"></a>导语</h2><p>有时业务中遇到这样的场景，多个项目有很多共用的逻辑，后面又是独立部署。例如PC端和移动端，UI完全不同，但逻辑有很多能复用，但是这里我们计划是分开部署。这里仅说有这种场景，大致痛点如下。</p>
<ol>
<li>分两个项目，则代码维护两套，复用逻辑要copy</li>
<li>合成一个项目：路由区分或者多页配置。这种上线部署的时候又会互相影响，部署则都刷新。且目录在一起，可扒取到另外一个项目的资源。</li>
</ol>
<p>为此，需要一种方式，能代码共仓以复用逻辑，但是打包部署可以独立。</p>
<h2 id="实现"><a href="#实现" class="headerlink" title="实现"></a>实现</h2><p>实现该需求，有如下考虑：</p>
<ol>
<li>既然可独立打包，那这里考虑打包的时候传参</li>
<li>多项目在打包配置上可能存在差异，可针对不同项目的灵活配置是必要的</li>
<li>涉及到部署，那部署的情况也是要考虑到的<h3 id="约定"><a href="#约定" class="headerlink" title="约定"></a>约定</h3>为方便表述，这里做个约定，我们的项目分为mobile、pc两个。</li>
</ol>
<h3 id="打包传参的处理"><a href="#打包传参的处理" class="headerlink" title="打包传参的处理"></a>打包传参的处理</h3><p>命令行打包，做以下区分：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># mobile</span></span><br><span class="line"><span class="comment"># 本地运行</span></span><br><span class="line">npm run dev -- --page=mobile</span><br><span class="line"><span class="comment"># 打包</span></span><br><span class="line">npm run build -- --page=mobile</span><br><span class="line"></span><br><span class="line"><span class="comment"># pc</span></span><br><span class="line"><span class="comment"># 本地运行</span></span><br><span class="line">npm run dev -- --page=pc</span><br><span class="line"><span class="comment"># 打包</span></span><br><span class="line">npm run build -- --page=pc</span><br></pre></td></tr></table></figure>
<p>以上是参数的传入，接着解析参数，做成通用的，形如 <code>--key=value</code>的都可以被解析。<br>这里我们将参数写成 <code>VUE_APP_PAGE</code>的形式，这样项目代码逻辑中也可以使用这个参数，以便处理复用代码要区分不同项目的场景。<br>同时，这里实现<code>getEnv</code>函数，以便在其他打包逻辑中可以获取到自己想要的参数。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用正则解析参数</span></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">handleEnv</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">  <span class="keyword">const</span> reg = <span class="regexp">/--(\w+)=(.+)/</span>;</span><br><span class="line">  <span class="keyword">const</span> keysArr = process.argv.filter( <span class="function"><span class="params">e</span> =&gt;</span> reg.test(e));</span><br><span class="line">  keysArr.forEach( <span class="function"><span class="params">varStr</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">const</span> varArr = varStr.match(reg);</span><br><span class="line">    process.env[<span class="string">`VUE_APP_<span class="subst">$&#123;varArr[<span class="number">1</span>].toLocaleUpperCase()&#125;</span>`</span>] = varArr[<span class="number">2</span>];</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取对应的参数，如果key不传则返回所有的，这里做一次缓存代理，避免重复解析</span></span><br><span class="line"><span class="keyword">const</span> getEnv = (<span class="function">() =&gt;</span> &#123;</span><br><span class="line">  <span class="keyword">let</span> isHandleEnv = <span class="literal">false</span>;</span><br><span class="line">  <span class="keyword">return</span> <span class="function">(<span class="params">key</span>) =&gt;</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (!isHandleEnv) &#123;</span><br><span class="line">      handleEnv();</span><br><span class="line">      isHandleEnv = <span class="literal">true</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> key ? process.env[key] :process.env;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;)();</span><br></pre></td></tr></table></figure>
<p>以上已经拿到了参数，接下来是参数用起来</p>
<h3 id="处理打包配置"><a href="#处理打包配置" class="headerlink" title="处理打包配置"></a>处理打包配置</h3><p>这里总的逻辑还是使用了pages配置项，不过每次只打包了一个page。首先说明文件，为了方便自定义配置，这里我们拆分文件：</p>
<ul>
<li><code>common.config.js</code>用来存储多个项目公用的配置</li>
<li><code>custom.config.js</code>用来存储不同项目自定义的配置</li>
<li><code>vue.config.js</code>合并common、custom的配置，生成最终的打包配置</li>
</ul>
<p><code>common.config.js</code>的配置举例如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="attr">publicPath</span>: <span class="string">&#x27;./&#x27;</span>,</span><br><span class="line">  <span class="attr">assetsDir</span>: <span class="string">&#x27;static&#x27;</span>,</span><br><span class="line">  <span class="attr">productionSourceMap</span>: <span class="literal">false</span>,</span><br><span class="line">  <span class="attr">lintOnSave</span>: <span class="literal">true</span>,</span><br><span class="line">  <span class="attr">devServer</span>: &#123;</span><br><span class="line">    <span class="attr">host</span>: <span class="string">&#x27;0.0.0.0&#x27;</span>,</span><br><span class="line">    <span class="attr">port</span>: <span class="number">3000</span>,</span><br><span class="line">    <span class="attr">hotOnly</span>: <span class="literal">true</span>, </span><br><span class="line">    <span class="attr">proxy</span>: &#123;</span><br><span class="line">      <span class="string">&#x27;/&#x27;</span>: &#123;</span><br><span class="line">        <span class="attr">ws</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">target</span>: <span class="string">&#x27;http://test.myproject.com/&#x27;</span>,</span><br><span class="line">        <span class="attr">changeOrigin</span>: <span class="literal">true</span>,</span><br><span class="line">        <span class="attr">secure</span>: <span class="literal">false</span>,</span><br><span class="line">      &#125;,</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="attr">configureWebpack</span>: <span class="function"><span class="params">config</span> =&gt;</span> &#123;</span><br><span class="line">    <span class="comment">// 这里写自定义的webpack配置</span></span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="function"><span class="title">chainWebpack</span>(<span class="params">config</span>)</span> &#123;</span><br><span class="line">    <span class="comment">// 这里我们设置了一下别名</span></span><br><span class="line">    config.resolve.alias</span><br><span class="line">      .set(<span class="string">&#x27;@pc&#x27;</span>, resolve(<span class="string">&#x27;./src/pc&#x27;</span>))</span><br><span class="line">      .set(<span class="string">&#x27;@mobile&#x27;</span>, resolve(<span class="string">&#x27;./src/mobile&#x27;</span>))</span><br><span class="line">      .set(<span class="string">&#x27;@src&#x27;</span>, resolve(<span class="string">&#x27;./src&#x27;</span>))</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>custom.config.js</code>的配置举例如下：</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  <span class="comment">// 移动端的自定义配置</span></span><br><span class="line">  <span class="attr">mobile</span>: &#123;</span><br><span class="line">    <span class="comment">// page的自定义配置，后面会和默认的配置合并</span></span><br><span class="line">    <span class="attr">page</span>: &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;mobile title&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// pc端的自定义配置</span></span><br><span class="line">  <span class="attr">pc</span>: &#123;</span><br><span class="line">    <span class="attr">page</span>: &#123;</span><br><span class="line">      <span class="attr">title</span>: <span class="string">&#x27;pc title&#x27;</span></span><br><span class="line">    &#125;,</span><br><span class="line">    <span class="function"><span class="title">chainWebpack</span>(<span class="params">config</span>)</span> &#123;</span><br><span class="line">      <span class="comment">// 这里我们设置了一下pc端的svg打包，但是移动端不需要，因此是在自定义配置</span></span><br><span class="line">      config.module</span><br><span class="line">      .rule(<span class="string">&#x27;svg&#x27;</span>)</span><br><span class="line">      .exclude.add(resolve(<span class="string">&#x27;src/platform/icons&#x27;</span>))</span><br><span class="line">      .end()</span><br><span class="line">    config.module</span><br><span class="line">      .rule(<span class="string">&#x27;icons&#x27;</span>)</span><br><span class="line">      .test(<span class="regexp">/\.svg$/</span>)</span><br><span class="line">      .include.add(resolve(<span class="string">&#x27;src/platform/icons&#x27;</span>))</span><br><span class="line">      .end()</span><br><span class="line">      .use(<span class="string">&#x27;svg-sprite-loader&#x27;</span>)</span><br><span class="line">      .loader(<span class="string">&#x27;svg-sprite-loader&#x27;</span>)</span><br><span class="line">      .options(&#123;</span><br><span class="line">        <span class="attr">symbolId</span>: <span class="string">&#x27;icon-[name]&#x27;</span></span><br><span class="line">      &#125;)</span><br><span class="line">      .end()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p><code>vue.config.js</code>的配置，这块是重点，会结合上面两个配置生成最终的配置。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> path = <span class="built_in">require</span>(<span class="string">&#x27;path&#x27;</span>);</span><br><span class="line"><span class="keyword">const</span> fs = <span class="built_in">require</span>(<span class="string">&#x27;fs&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 导入以上两份配置</span></span><br><span class="line"><span class="keyword">const</span> commonConfig = <span class="built_in">require</span>(<span class="string">&#x27;./common.config&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> customConfig = <span class="built_in">require</span>(<span class="string">&#x27;./custom.config&#x27;</span>)</span><br><span class="line"><span class="keyword">const</span> &#123; getEnv &#125; = <span class="built_in">require</span>(<span class="string">&#x27;./utils&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取到了当前的page参数</span></span><br><span class="line"><span class="keyword">let</span> pageName = getEnv(<span class="string">&#x27;VUE_APP_PAGE&#x27;</span>);</span><br><span class="line"></span><br><span class="line"><span class="comment">// 我们将pc和mobile两个项目放到了 `src/pages` 目录下</span></span><br><span class="line"><span class="keyword">const</span> dirs = fs.readdirSync(path.join(__dirname, <span class="string">&#x27;src/pages&#x27;</span>))</span><br><span class="line"></span><br><span class="line"><span class="comment">// 异常处理，当pageName没匹配到时默认做pc处理</span></span><br><span class="line"><span class="keyword">if</span> (!dirs.includes(pageName)) &#123;</span><br><span class="line">  <span class="built_in">console</span>.warn(<span class="string">`<span class="subst">$&#123;pageName&#125;</span> is not exist`</span>);</span><br><span class="line">  pageName = <span class="string">&#x27;pc&#x27;</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 获取对应页面的自定义配置，这里page参数单独拿出作为后面pages配置的合并，其他参数走通用的合并</span></span><br><span class="line"><span class="keyword">const</span> &#123; page, ...pageCustomConfig &#125; = customConfig[pageName] || &#123; <span class="attr">page</span>: &#123;&#125; &#125;;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 根据pageName生成对应的pages配置，这里合并上一步的page参数，目的是当两个项目index.html使用一份的时候，可以不放置两个html，而是使用一个，但是可以通过page参数指定title参数区分</span></span><br><span class="line"><span class="keyword">const</span> defaultPageConfig = &#123;</span><br><span class="line">  <span class="attr">pages</span>: &#123;</span><br><span class="line">    [pageName]: &#123;</span><br><span class="line">      <span class="attr">entry</span>: <span class="string">`src/<span class="subst">$&#123;pageName&#125;</span>/main.js`</span>,</span><br><span class="line">      <span class="attr">template</span>: <span class="string">`public/<span class="subst">$&#123;pageName&#125;</span>.html`</span>,</span><br><span class="line">      <span class="attr">filename</span>: <span class="string">&#x27;index.html&#x27;</span>,</span><br><span class="line">      ...page</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;,</span><br><span class="line">  <span class="comment">// ☆ 这里是关键，打包到dist下面对应项目的子目录，这样可以分开打包两个项目，互不影响</span></span><br><span class="line">  <span class="attr">outputDir</span>: <span class="string">`dist/<span class="subst">$&#123;pageName&#125;</span>`</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 这里的config就是我们生成的基本配置啦，但是custom的配置还没处理</span></span><br><span class="line"><span class="keyword">const</span> config = &#123;</span><br><span class="line">  ...baseConfig,</span><br><span class="line">  ...defaultPageConfig,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 遍历自定义配置pageCustomConfig</span></span><br><span class="line"><span class="keyword">for</span> (<span class="keyword">const</span> key <span class="keyword">in</span> pageCustomConfig) &#123;</span><br><span class="line">  <span class="keyword">if</span> (<span class="built_in">Object</span>.hasOwnProperty.call(pageCustomConfig, key)) &#123;</span><br><span class="line">    <span class="comment">// 这里拿到的配置有可能是值、也有可能是函数(例如：chainWebpack)</span></span><br><span class="line">    <span class="keyword">const</span> valueOrFunction = pageCustomConfig[key];</span><br><span class="line"></span><br><span class="line">    <span class="comment">// 当自定义页面配置为函数时，默认会合并自定义配置和baseConfig中的配置。</span></span><br><span class="line">    <span class="keyword">if</span> (valueOrFunction <span class="keyword">instanceof</span> <span class="built_in">Function</span>) &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 拿到了通用配置中相同项，做函数合并。</span></span><br><span class="line">      <span class="keyword">const</span> baseFunction = config[key] || <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;&#125;;</span><br><span class="line">      config[key] = <span class="function"><span class="keyword">function</span>(<span class="params"></span>) </span>&#123;</span><br><span class="line">        <span class="comment">// 先调用自定义的配置的函数，如果返回true则代表自定义配置完全覆盖common配置，否则两者合并</span></span><br><span class="line">        <span class="keyword">const</span> isReplaceBase = valueOrFunction.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>);</span><br><span class="line">        <span class="comment">// 两者合并的情况，调用common中的配置</span></span><br><span class="line">        !isReplaceBase &amp;&amp; baseFunction.apply(<span class="literal">null</span>, <span class="built_in">arguments</span>);</span><br><span class="line">      &#125;</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      <span class="comment">// 不是函数，则直接覆盖</span></span><br><span class="line">      config[key] = valueOrFunction;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = config;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>另外，有些情况可能仅在上面的自定义配置中无法完成，例如这里要修改<code>postcss</code>的配置完成移动端rem的配置，可以修改<code>postcss.config.js</code></p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">const</span> &#123; getEnv &#125; = <span class="built_in">require</span>(<span class="string">&#x27;./utils&#x27;</span>)</span><br><span class="line"></span><br><span class="line"><span class="keyword">const</span> plugins = &#123;</span><br><span class="line">  <span class="attr">autoprefixer</span>: &#123;&#125;,</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">// 使用 getEnv 获取当前的page参数，仅在移动端设置rem转化</span></span><br><span class="line"><span class="keyword">if</span> (getEnv(<span class="string">&#x27;VUE_APP_PAGE&#x27;</span>) === <span class="string">&#x27;mobile&#x27;</span>) &#123;</span><br><span class="line">  plugins[<span class="string">&#x27;postcss-pxtorem&#x27;</span>] = &#123;</span><br><span class="line">    <span class="attr">rootValue</span>: <span class="number">16</span>,</span><br><span class="line">    <span class="attr">propList</span>: [<span class="string">&#x27;*&#x27;</span>],</span><br><span class="line">    <span class="attr">unitPrecision</span>: <span class="number">5</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="built_in">module</span>.exports = &#123;</span><br><span class="line">  plugins</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="package-json的修改"><a href="#package-json的修改" class="headerlink" title="package.json的修改"></a>package.json的修改</h3><p>以上就完成了自定义的打包，但是本地运行还要每次传参就比较麻烦，改下<code>package.json</code>让项目更好用。</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;scripts&quot;</span>: &#123;</span><br><span class="line">    <span class="comment">// 默认启动pc</span></span><br><span class="line">    <span class="string">&quot;dev&quot;</span>: <span class="string">&quot;vue-cli-service serve&quot;</span>,</span><br><span class="line">    <span class="comment">// 启动移动端</span></span><br><span class="line">    <span class="string">&quot;dev:collection&quot;</span>: <span class="string">&quot;npm run dev -- --page=mobile&quot;</span>,</span><br><span class="line">    <span class="comment">// 默认打包pc</span></span><br><span class="line">    <span class="string">&quot;build&quot;</span>: <span class="string">&quot;vue-cli-service build&quot;</span>,</span><br><span class="line">    <span class="comment">// 两者一起打包</span></span><br><span class="line">    <span class="string">&quot;build:all&quot;</span>: <span class="string">&quot;npm run build &amp;&amp; npm run build:mobile&quot;</span>,</span><br><span class="line">    <span class="string">&quot;build:pc&quot;</span>: <span class="string">&quot;vue-cli-service build&quot;</span>,</span><br><span class="line">    <span class="comment">// 单独打包移动端</span></span><br><span class="line">    <span class="string">&quot;build:mobile&quot;</span>: <span class="string">&quot;npm run build -- --page=mobile&quot;</span>,</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="部署"><a href="#部署" class="headerlink" title="部署"></a>部署</h2><p>完成以上打包之后，考虑下部署的事情。之前可能部署的方式是直接删除旧的前端包，部署新的。那现在情况不太一样了，<code>pc</code>、<code>mobile</code>都要部署则可以这么干，但是如果只是部署<code>mobile</code>，那之前前端包中的<code>pc</code>就不能删除，这里我们改写下部署的 <code>bash</code>脚本。可能你不是<code>bash</code>脚本，但是原理一样。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"><span class="comment"># 指定项目目录名称</span></span><br><span class="line">PROJECT_DIR=my-test-project</span><br><span class="line"><span class="comment"># 指定项目目录放置的地方</span></span><br><span class="line">BASE_DIR=/home/www</span><br><span class="line"><span class="comment"># 解压比对的临时目录</span></span><br><span class="line">PROJECT_DIR_TEMP=<span class="variable">$&#123;BASE_DIR&#125;</span>/<span class="variable">$&#123;PROJECT_DIR&#125;</span>-temp</span><br><span class="line"><span class="comment"># 项目的根目录</span></span><br><span class="line">PROJECT_ROOT_DIR=<span class="variable">$&#123;BASE_DIR&#125;</span>/<span class="variable">$&#123;PROJECT_DIR&#125;</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 处理部署的时候新建项目目录</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="variable">$&#123;PROJECT_ROOT_DIR&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">mkdir -p <span class="variable">$&#123;PROJECT_ROOT_DIR&#125;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 创建临时目录</span></span><br><span class="line"><span class="keyword">if</span> [ ! -d <span class="variable">$&#123;PROJECT_DIR_TEMP&#125;</span> ];<span class="keyword">then</span></span><br><span class="line">mkdir -p <span class="variable">$&#123;PROJECT_DIR_TEMP&#125;</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 拷贝前端包到临时目录，并解压操作</span></span><br><span class="line">cp <span class="variable">$&#123;PROJECT_DIR&#125;</span>.zip <span class="variable">$&#123;PROJECT_DIR_TEMP&#125;</span></span><br><span class="line"><span class="built_in">cd</span> <span class="variable">$&#123;PROJECT_DIR_TEMP&#125;</span></span><br><span class="line">unzip <span class="variable">$&#123;PROJECT_DIR&#125;</span>.zip</span><br><span class="line">rm <span class="variable">$&#123;PROJECT_DIR&#125;</span>.zip</span><br><span class="line"></span><br><span class="line"><span class="comment"># 此处遍历前端包中的目录，有以下情况</span></span><br><span class="line"><span class="comment"># 1. 有pc、mobile两个目录，则是两个项目一块部署，之前两个目录均删除</span></span><br><span class="line"><span class="comment"># 2. 仅有一个目录，如仅有mobile目录，则只部署移动端，pc端代码不部署</span></span><br><span class="line"><span class="keyword">for</span> file <span class="keyword">in</span> <span class="variable">$PROJECT_DIR_TEMP</span>/*</span><br><span class="line"><span class="keyword">do</span></span><br><span class="line"><span class="keyword">if</span> [ -d <span class="string">&quot;<span class="variable">$file</span>&quot;</span> ]</span><br><span class="line"><span class="keyword">then</span></span><br><span class="line">  <span class="comment"># 此处读取目录的名称，匹配最后一个 / 之后的名称</span></span><br><span class="line">  page_name=<span class="variable">$&#123;file##*/&#125;</span></span><br><span class="line">  <span class="built_in">echo</span> <span class="variable">$page_name</span></span><br><span class="line"></span><br><span class="line">  <span class="comment"># 如果在项目根目录下存在当前目录，则删除掉该旧目录</span></span><br><span class="line">  <span class="keyword">if</span> [ -d <span class="string">&quot;<span class="variable">$PROJECT_ROOT_DIR</span>/<span class="variable">$page_name</span>&quot;</span> ]</span><br><span class="line">  <span class="keyword">then</span></span><br><span class="line">    rm -r <span class="string">&quot;<span class="variable">$PROJECT_ROOT_DIR</span>/<span class="variable">$page_name</span>&quot;</span></span><br><span class="line">  <span class="keyword">fi</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"><span class="keyword">done</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除之后将临时目录下解压的文件全部移到项目根目录</span></span><br><span class="line">mv <span class="variable">$PROJECT_DIR_TEMP</span>/* <span class="variable">$PROJECT_ROOT_DIR</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># 删除临时目录</span></span><br><span class="line">rm -r <span class="variable">$PROJECT_DIR_TEMP</span></span><br></pre></td></tr></table></figure>

        </div>

        

        
            <div class="article-nav">
                
                    <div class="article-prev">
                        <a class="prev"
                           rel="prev"
                           href="/2022/05/11/shell%E5%AD%A6%E4%B9%A0%E8%AE%B0%E5%BD%95/"
                        >
                            <span class="left arrow-icon flex-center">
                              <i class="fas fa-chevron-left"></i>
                            </span>
                            <span class="title flex-center">
                                <span class="post-nav-title-item">shell学习记录</span>
                                <span class="post-nav-item">上一篇</span>
                            </span>
                        </a>
                    </div>
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2021/11/21/hexo%E4%BD%BF%E7%94%A8rsync%E9%83%A8%E7%BD%B2%E5%A1%AB%E5%9D%91%E4%B9%8B%E8%B7%AF/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">hexo使用rsync部署填坑之路</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2021</span>&nbsp;-&nbsp;
            
            2022&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Star Sea</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                
            </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.3</a>
        </div>
        
            <div class="icp-info info-item"><a target="_blank" rel="nofollow" href="https://beian.miit.gov.cn">鄂ICP备19020693号-3</a></div>
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AF%BC%E8%AF%AD"><span class="nav-text">导语</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%AE%9E%E7%8E%B0"><span class="nav-text">实现</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BA%A6%E5%AE%9A"><span class="nav-text">约定</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%89%93%E5%8C%85%E4%BC%A0%E5%8F%82%E7%9A%84%E5%A4%84%E7%90%86"><span class="nav-text">打包传参的处理</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A4%84%E7%90%86%E6%89%93%E5%8C%85%E9%85%8D%E7%BD%AE"><span class="nav-text">处理打包配置</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#package-json%E7%9A%84%E4%BF%AE%E6%94%B9"><span class="nav-text">package.json的修改</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%83%A8%E7%BD%B2"><span class="nav-text">部署</span></a></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>




    
<script src="/js/lazyload.js"></script>



<div class="post-scripts pjax">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":200,"height":300},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
