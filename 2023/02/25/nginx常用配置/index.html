<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="utf-8">
    <meta name="referrer" content="no-referrer" />
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
    <meta name="keywords" content="Hexo Theme Keep">
    <meta name="description" content="Hexo Theme Keep">
    <meta name="author" content="Star Sea">
    
    <title>
        
            nginx常用配置 |
        
        StarSea
    </title>
    
<link rel="stylesheet" href="/css/style.css">

    <link rel="shortcut icon" href="/images/avatar.jpg">
    
<link rel="stylesheet" href="/css/font-awesome.min.css">

    <script id="hexo-configurations">
    let KEEP = window.KEEP || {};
    KEEP.hexo_config = {"hostname":"www.starsea.club","root":"/","language":"zh-CN","path":"search.json"};
    KEEP.theme_config = {"toc":{"enable":true,"number":false,"expand_all":true,"init_open":true},"style":{"primary_color":"#0066CC","avatar":"/images/avatar.jpg","favicon":"/images/avatar.jpg","article_img_align":"left","left_side_width":"260px","content_max_width":"920px","hover":{"shadow":true,"scale":true},"first_screen":{"enable":true,"background_img":"/images/bg.svg","description":"上次写博客，还是上一次"},"scroll":{"progress_bar":false,"percent":true}},"local_search":{"enable":true,"preload":false},"code_copy":{"enable":true,"style":"mac"},"pjax":{"enable":true},"lazyload":{"enable":true},"version":"3.4.3"};
    KEEP.language_ago = {"second":"%s 秒前","minute":"%s 分钟前","hour":"%s 小时前","day":"%s 天前","week":"%s 周前","month":"%s 月前","year":"%s 年前"};
  </script>
<meta name="generator" content="Hexo 5.4.0"></head>


<body>
<div class="progress-bar-container">
    

    
        <span class="pjax-progress-bar"></span>
        <span class="pjax-progress-icon">
            <i class="fas fa-circle-notch fa-spin"></i>
        </span>
    
</div>


<main class="page-container">

    

    <div class="page-main-content">

        <div class="page-main-content-top">
            <header class="header-wrapper">

    <div class="header-content">
        <div class="left">
            
            <a class="logo-title" href="/">
                StarSea
            </a>
        </div>

        <div class="right">
            <div class="pc">
                <ul class="menu-list">
                    
                        <li class="menu-item">
                            <a class=""
                               href="/"
                            >
                                首页
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/archives"
                            >
                                归档
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/categories"
                            >
                                分类
                            </a>
                        </li>
                    
                        <li class="menu-item">
                            <a class=""
                               href="/tags"
                            >
                                标签
                            </a>
                        </li>
                    
                    
                        <li class="menu-item search search-popup-trigger">
                            <i class="fas fa-search"></i>
                        </li>
                    
                </ul>
            </div>
            <div class="mobile">
                
                    <div class="icon-item search search-popup-trigger"><i class="fas fa-search"></i></div>
                
                <div class="icon-item menu-bar">
                    <div class="menu-bar-middle"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="header-drawer">
        <ul class="drawer-menu-list">
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/">首页</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/archives">归档</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/categories">分类</a>
                </li>
            
                <li class="drawer-menu-item flex-center">
                    <a class=""
                       href="/tags">标签</a>
                </li>
            
        </ul>
    </div>

    <div class="window-mask"></div>

</header>


        </div>

        <div class="page-main-content-middle">

            <div class="main-content">

                
                    <div class="fade-in-down-animation">
    <div class="article-content-container">

        <div class="article-title">
            <span class="title-hover-animation">nginx常用配置</span>
        </div>

        
            <div class="article-header">
                <div class="avatar">
                    <img src="/images/avatar.jpg">
                </div>
                <div class="info">
                    <div class="author">
                        <span class="name">Star Sea</span>
                        
                    </div>
                    <div class="meta-info">
                        <div class="article-meta-info">
    <span class="article-date article-meta-item">
        <i class="fas fa-edit"></i>&nbsp;2023-02-25 14:19:23
    </span>
    
        <span class="article-categories article-meta-item">
            <i class="fas fa-folder"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/categories/%E6%9C%8D%E5%8A%A1%E5%99%A8/">服务器</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    
    
        <span class="article-tags article-meta-item">
            <i class="fas fa-tags"></i>&nbsp;
            <ul>
                
                    <li>
                        <a href="/tags/nginx/">nginx</a>&nbsp;
                    </li>
                
            </ul>
        </span>
    

    
    
        <span class="article-wordcount article-meta-item">
            <i class="fas fa-file-word"></i>&nbsp;<span>1.9k 字</span>
        </span>
    
    
        <span class="article-min2read article-meta-item">
            <i class="fas fa-clock"></i>&nbsp;<span>8 分钟</span>
        </span>
    
    
        <span class="article-pv article-meta-item">
            <i class="fas fa-eye"></i>&nbsp;<span id="busuanzi_value_page_pv"></span>
        </span>
    
</div>

                    </div>
                </div>
            </div>
        

        <div class="article-content markdown-body">
            <h2 id="配置文件结构"><a href="#配置文件结构" class="headerlink" title="配置文件结构"></a>配置文件结构</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">worker_processes</span>  <span class="number">1</span>；                			     <span class="comment"># worker进程的数量</span></span><br><span class="line">events &#123;                              			   <span class="comment"># 事件区块开始</span></span><br><span class="line">    <span class="attribute">worker_connections</span>  <span class="number">1024</span>；          		   <span class="comment"># 每个worker进程支持的最大连接数</span></span><br><span class="line">&#125;                               			         <span class="comment"># 事件区块结束</span></span><br><span class="line">http &#123;                           			         <span class="comment"># HTTP区块开始</span></span><br><span class="line">    <span class="attribute">include</span>       mime.types；         			   <span class="comment"># Nginx支持的媒体类型库文件</span></span><br><span class="line">    default_type  application/octet-stream；   <span class="comment"># 默认的媒体类型</span></span><br><span class="line">    sendfile        <span class="literal">on</span>；       				         <span class="comment"># 开启高效传输模式</span></span><br><span class="line">    keepalive_timeout  <span class="number">65</span>；       			       <span class="comment"># 连接超时</span></span><br><span class="line">    server &#123;            		                   <span class="comment"># 第一个Server区块开始，表示一个独立的虚拟主机站点</span></span><br><span class="line">        <span class="attribute">listen</span>       <span class="number">80</span>；      			           <span class="comment"># 提供服务的端口，默认80</span></span><br><span class="line">        server_name  localhost；    			     <span class="comment"># 提供服务的域名主机名</span></span><br><span class="line">        location / &#123;            	        	   <span class="comment"># 第一个location区块开始</span></span><br><span class="line">            <span class="attribute">root</span>   html；       			         <span class="comment"># 站点的根目录，相当于Nginx的安装目录</span></span><br><span class="line">            index  index.html index.htm；      <span class="comment"># 默认的首页文件，多个用空格分开</span></span><br><span class="line">        &#125;          				                     <span class="comment"># 第一个location区块结果</span></span><br><span class="line">        error_page   <span class="number">500502503504</span>  /50x.html； <span class="comment"># 出现对应的http状态码时，使用50x.html回应客户</span></span><br><span class="line">        location = /50x.html &#123;          	     <span class="comment"># location区块开始，访问50x.html</span></span><br><span class="line">            <span class="attribute">root</span>   html；      		      	     <span class="comment"># 指定对应的站点目录为html</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="location的匹配"><a href="#location的匹配" class="headerlink" title="location的匹配"></a>location的匹配</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#优先级1,精确匹配，根路径</span></span><br><span class="line"><span class="attribute">location</span> =/ &#123;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">400</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#优先级2,以某个字符串开头,以av开头的，优先匹配这里，区分大小写</span></span><br><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /av &#123;</span><br><span class="line">   <span class="attribute">root</span> /data/av/;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#优先级3，区分大小写的正则匹配，匹配/media*****路径</span></span><br><span class="line"><span class="attribute">location</span> <span class="regexp">~ /media</span> &#123;</span><br><span class="line">      <span class="attribute">alias</span> /data/static/;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#优先级4 ，不区分大小写的正则匹配，所有的****.jpg|gif|png 都走这里</span></span><br><span class="line"><span class="attribute">location</span> <span class="regexp">~* .*\.(jpg|gif|png|js|css)$</span> &#123;</span><br><span class="line">   <span class="attribute">root</span>  /data/av/;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">#优先7，通用匹配</span></span><br><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">return</span> <span class="number">403</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h2 id="常用全局变量"><a href="#常用全局变量" class="headerlink" title="常用全局变量"></a>常用全局变量</h2><table>
<thead>
<tr>
<th>变量</th>
<th>含义</th>
</tr>
</thead>
<tbody><tr>
<td>$args</td>
<td>这个变量等于请求行中的参数，同$query_string</td>
</tr>
<tr>
<td>$content length</td>
<td>请求头中的Content-length字段。</td>
</tr>
<tr>
<td>$content_type</td>
<td>请求头中的Content-Type字段。</td>
</tr>
<tr>
<td>$document_root</td>
<td>当前请求在root指令中指定的值。</td>
</tr>
<tr>
<td>$host</td>
<td>请求主机头字段，否则为服务器名称。</td>
</tr>
<tr>
<td>$http_user_agent</td>
<td>客户端agent信息</td>
</tr>
<tr>
<td>$http_cookie</td>
<td>客户端cookie信息</td>
</tr>
<tr>
<td>$limit_rate</td>
<td>这个变量可以限制连接速率。</td>
</tr>
<tr>
<td>$request_method</td>
<td>客户端请求的动作，通常为GET或POST。</td>
</tr>
<tr>
<td>$remote_addr</td>
<td>客户端的IP地址。</td>
</tr>
<tr>
<td>$remote_port</td>
<td>客户端的端口。</td>
</tr>
<tr>
<td>$remote_user</td>
<td>已经经过Auth Basic Module验证的用户名。</td>
</tr>
<tr>
<td>$request_filename</td>
<td>当前请求的文件路径，由root或alias指令与URI请求生成。</td>
</tr>
<tr>
<td>$scheme</td>
<td>HTTP方法（如http，https）。</td>
</tr>
<tr>
<td>$server_protocol</td>
<td>请求使用的协议，通常是HTTP/1.0或HTTP/1.1。</td>
</tr>
<tr>
<td>$server_addr</td>
<td>服务器地址，在完成一次系统调用后可以确定这个值。</td>
</tr>
<tr>
<td>$server_name</td>
<td>服务器名称。</td>
</tr>
<tr>
<td>$server_port</td>
<td>请求到达服务器的端口号。</td>
</tr>
<tr>
<td>$request_uri</td>
<td>包含请求参数的原始URI，不包含主机名，如”/foo/bar.php?arg=baz”。</td>
</tr>
<tr>
<td>$uri</td>
<td>不带请求参数的当前URI，$uri不包含主机名，如”/foo/bar.html”。</td>
</tr>
<tr>
<td>$document_uri</td>
<td>与$uri相同。</td>
</tr>
</tbody></table>
<h2 id="缓存配置"><a href="#缓存配置" class="headerlink" title="缓存配置"></a>缓存配置</h2><h3 id="配置缓存时间"><a href="#配置缓存时间" class="headerlink" title="配置缓存时间"></a>配置缓存时间</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~* .(gif|jpg|png|bmp|ico)$</span> &#123;</span><br><span class="line">  <span class="comment">#设置缓存时间</span></span><br><span class="line">   <span class="attribute">expires</span> <span class="number">1d</span>;  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="使用协商缓存"><a href="#使用协商缓存" class="headerlink" title="使用协商缓存"></a>使用协商缓存</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">  <span class="attribute">root</span> html;</span><br><span class="line">  <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">  <span class="attribute">add_header</span> Cache-Control <span class="literal">no</span>-store;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="禁止缓存"><a href="#禁止缓存" class="headerlink" title="禁止缓存"></a>禁止缓存</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">  <span class="attribute">root</span> html;</span><br><span class="line">  <span class="attribute">index</span>  index.html index.htm;</span><br><span class="line">  <span class="attribute">add_header</span> Cache-Control <span class="literal">no</span>-store;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="缓存相关标识"><a href="#缓存相关标识" class="headerlink" title="缓存相关标识"></a>缓存相关标识</h3><h4 id="Etag"><a href="#Etag" class="headerlink" title="Etag"></a>Etag</h4><p>Etag 是一种作为web资源关联的标记，由响应头传送给客户端，下次请求会通过请求头 If-None-Match 带上，若服务器资源未发生变化，则返回 304 状态码。它主要是为了解决 Last-Modified 上的一些不足，比如，</p>
<ol>
<li>某些文件修改是在秒级以下速度进行修改，但If-Modified-Since 能检查到的粒度是s级的。采用弱 Etag，此时它是基于 MTime 来生成，只能精确到s，所以1s秒内生成的 Etag 是一样的。可以避免强 Etag 造成的频繁缓存刷新。弱 Etag 以 W/ 开头。</li>
<li>某些文件会周期性变更，但其内容是不变化的，此时我们不希望它被认为被修改了等。</li>
<li>某些服务器不能精准获取文件的最后修改时间。<h4 id="文件存储"><a href="#文件存储" class="headerlink" title="文件存储"></a>文件存储</h4><h5 id="from-memory-cache"><a href="#from-memory-cache" class="headerlink" title="from memory cache"></a><strong>from memory cache</strong></h5>不请求网络资源，资源存储在内存中，一般存储的有字体、图片、脚本。<h5 id="from-disk-cache"><a href="#from-disk-cache" class="headerlink" title="from disk cache"></a><strong>from disk cache</strong></h5>不请求网络资源，资源存储在磁盘中，一般存储非脚本资源，如css。<h3 id="try-files"><a href="#try-files" class="headerlink" title="try_files"></a>try_files</h3>Vue项目中设置<code>history</code>模式需要设置try_files。<br>try_file 后面必须有一个file, 一个 url 或 code,file 可以有多个。<br>简单来说，try_file 按顺序检查 file,如果是文件夹，请在 file后加 / ，如果 file 都不存在，根据最后一个参数做跳转。<br>@ 在location 中的用法。 @ 相当于命名了一个变量。<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line">    <span class="attribute">try_files</span> /system/maintenance.html</span><br><span class="line">              $uri $uri/index.html $uri.html</span><br><span class="line">              @mongrel;</span><br><span class="line">&#125;</span><br><span class="line"><span class="attribute">location</span> @mongrel &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://mongrel;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
单页应用中设置如下：<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> / &#123;</span><br><span class="line"> <span class="attribute">try_files</span> $uri $uri/ /index.html</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="pass-proxy-代理"><a href="#pass-proxy-代理" class="headerlink" title="pass_proxy 代理"></a>pass_proxy 代理</h2><h3 id="不带斜杠"><a href="#不带斜杠" class="headerlink" title="不带斜杠"></a>不带斜杠</h3>前端 /api/user<br>后端 /api/user<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /api/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:3001;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
不带斜杠把 path 直接拼接在 url后面；<h3 id="带斜杠"><a href="#带斜杠" class="headerlink" title="带斜杠"></a>带斜杠</h3>前端 /api/user<br>后端 /user<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /api/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:3001/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
带斜杠会先去掉匹配到的 path, 再拼接。<h3 id="正则匹配的时候不能带斜杠"><a href="#正则匹配的时候不能带斜杠" class="headerlink" title="正则匹配的时候不能带斜杠"></a>正则匹配的时候不能带斜杠</h3>~ 区分大小写正则匹配 ，~* 不区分大小写正则匹配 。location 用正则匹配的时候，proxy_pass 后面不能以 / 结尾，因为 nginx 不能处理这种情况。一下这种情况不可行<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> <span class="regexp">~ /api/</span> &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:3001/;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="斜杠后面加路径"><a href="#斜杠后面加路径" class="headerlink" title="斜杠后面加路径"></a>斜杠后面加路径</h3>前端 /api/user<br>后端 /web/api/user<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span><span class="regexp"> ^~</span> /api/ &#123;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:3001/web$request_uri;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="代理之前rewrite"><a href="#代理之前rewrite" class="headerlink" title="代理之前rewrite"></a>代理之前rewrite</h3><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">location</span> /search/ &#123;</span><br><span class="line">    <span class="attribute">rewrite</span>    /search/([^/]+) /s?wd=<span class="variable">$1</span> <span class="literal">break</span>;</span><br><span class="line">    <span class="attribute">proxy_pass</span> http://127.0.0.1:3001;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="gzip"><a href="#gzip" class="headerlink" title="gzip"></a>gzip</h2><figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">server&#123;</span><br><span class="line">	<span class="attribute">gzip</span> <span class="literal">on</span>;</span><br><span class="line">	<span class="attribute">gzip_min_length</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
gzip 指令默认是 off,设置为 on 打开 gzip。如果只设置 gzip on gzip 可有不会生效，gzip 默认只对大于20字节的内容做处理。我们在测试的时候页面内容都很少，很容易少于 20 字节 gzip_min_length设为 0 代表所有大小都压缩。<h3 id="指定需要-gzip-的文件"><a href="#指定需要-gzip-的文件" class="headerlink" title="指定需要 gzip 的文件"></a>指定需要 gzip 的文件</h3>gzip 默认只压缩 text/html 类型的文件，如下添加css文件<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gzip_types</span> text/html,text/css;</span><br></pre></td></tr></table></figure>
<h3 id="压缩级别"><a href="#压缩级别" class="headerlink" title="压缩级别"></a>压缩级别</h3>gzip 有9个压缩级别，越高，压缩效果越好，但是对 cpu 的消耗越多。默认压缩级别为 1 。我们可以设置一个合适的级别，比如 2；<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gzip_comp_level</span> <span class="number">2</span>;</span><br></pre></td></tr></table></figure>
<h3 id="gzip-static"><a href="#gzip-static" class="headerlink" title="gzip_static"></a>gzip_static</h3>以先把文件压缩成 gzip，nginx 直接拿 gzip 过的文件就行了。预处理的好处不光是节省了 cpu 压缩时间，还可以 让 nginx 可以使用 sendfile 系统调用来传输文件，性能得到提高。<br>为了能直接拿 gzip 过的文件，需要 gzip_static 模块。 新版本的 nginx 已经默认安装了这个模块，如果是老版的 nginx 这个模块需要安装一下。<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">gzip_static</span> always; </span><br></pre></td></tr></table></figure>
gzip_static 可以有三个值。</li>
</ol>
<ul>
<li><strong>off</strong> 默认值。 不启用 gzip_static。gzip功能还是可以用的。</li>
<li><strong>on</strong> 启用。 当客户端支持 gzip的时候，发送压缩文件，不支持的时候发送原文件。</li>
<li><strong>always</strong> 总是。 不管客户端是否支持，都优先发送压缩文件。如果没有压缩文件，再发送原文件。<h3 id="负载均衡"><a href="#负载均衡" class="headerlink" title="负载均衡"></a>负载均衡</h3>通过upstream置顶，轮询依次访问服务器<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> servers &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.1</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.2</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="section">server</span> &#123;</span><br><span class="line">    <span class="attribute">listen</span>       <span class="number">80</span>;</span><br><span class="line">    <span class="attribute">server_name</span>  _;</span><br><span class="line">    <span class="attribute">location</span> / &#123;</span><br><span class="line">        <span class="attribute">proxy_pass</span>   http://servers;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>        Host    $host;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>        X-Real-IP       $remote_addr;</span><br><span class="line">        <span class="attribute">proxy_set_header</span>        X-Forwarded-For $proxy_add_x_forwarded_for;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
设置权重<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> servers &#123;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.1</span> weight=<span class="number">1</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.2</span> weight=<span class="number">2</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
根据IP分配请求，保持session<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> servers &#123;</span><br><span class="line">    ip_hash;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.1</span> ;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.2</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
根据url分配请求，这样可以实现静态资源来自同一服务器，做缓存处理<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> servers &#123;</span><br><span class="line">    <span class="attribute">hash</span> $request_uri;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.1</span> ;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.2</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
最小连接数设置。遍历后端集群，比较每个后端的conns/weight（连接数除权重），选取该值最小的后端。 如果有多个后端的 conns/weight 值同为最小，那么对它们采用加权轮询算法。<figure class="highlight nginx"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">upstream</span> servers &#123;</span><br><span class="line">    least_conn;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.1</span> weight=<span class="number">2</span>;</span><br><span class="line">    <span class="attribute">server</span> <span class="number">192.168.1.2</span> weight=<span class="number">1</span> ;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></li>
</ul>

        </div>

        

        
            <div class="article-nav">
                
                
                    <div class="article-next">
                        <a class="next"
                           rel="next"
                           href="/2022/06/20/%E5%88%86%E9%A1%B5hooks%E7%9A%84%E5%B0%81%E8%A3%85/"
                        >
                            <span class="title flex-center">
                                <span class="post-nav-title-item">分页hooks的封装</span>
                                <span class="post-nav-item">下一篇</span>
                            </span>
                            <span class="right arrow-icon flex-center">
                              <i class="fas fa-chevron-right"></i>
                            </span>
                        </a>
                    </div>
                
            </div>
        

        
    </div>
</div>


                
            </div>

        </div>

        <div class="page-main-content-bottom">
            <footer class="footer">
    <div class="info-container">
        <div class="copyright-info info-item">
            &copy;
            
              <span>2021</span>&nbsp;-&nbsp;
            
            2023&nbsp;<i class="fas fa-heart icon-animate"></i>&nbsp;<a href="/">Star Sea</a>
        </div>
        
            <script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script>
            <div class="website-count info-item">
                
                
            </div>
        
        <div class="theme-info info-item">
            由 <a target="_blank" href="https://hexo.io">Hexo</a> 驱动&nbsp;|&nbsp;主题&nbsp;<a class="theme-version" target="_blank" href="https://github.com/XPoet/hexo-theme-keep">Keep v3.4.3</a>
        </div>
        
            <div class="icp-info info-item"><a target="_blank" rel="nofollow" href="https://beian.miit.gov.cn">鄂ICP备19020693号-3</a></div>
        
    </div>
</footer>

        </div>
    </div>

    
        <div class="post-tools">
            <div class="post-tools-container">
    <ul class="tools-list">
        <!-- TOC aside toggle -->
        
            <li class="tools-item page-aside-toggle">
                <i class="fas fa-outdent"></i>
            </li>
        

        <!-- go comment -->
        
    </ul>
</div>

        </div>
    

    <div class="right-bottom-side-tools">
        <div class="side-tools-container">
    <ul class="side-tools-list">
        <li class="tools-item tool-font-adjust-plus flex-center">
            <i class="fas fa-search-plus"></i>
        </li>

        <li class="tools-item tool-font-adjust-minus flex-center">
            <i class="fas fa-search-minus"></i>
        </li>

        <li class="tools-item tool-expand-width flex-center">
            <i class="fas fa-arrows-alt-h"></i>
        </li>

        <li class="tools-item tool-dark-light-toggle flex-center">
            <i class="fas fa-moon"></i>
        </li>

        <!-- rss -->
        

        
            <li class="tools-item tool-scroll-to-top flex-center">
                <i class="fas fa-arrow-up"></i>
            </li>
        

        <li class="tools-item tool-scroll-to-bottom flex-center">
            <i class="fas fa-arrow-down"></i>
        </li>
    </ul>

    <ul class="exposed-tools-list">
        <li class="tools-item tool-toggle-show flex-center">
            <i class="fas fa-cog fa-spin"></i>
        </li>
        
    </ul>
</div>

    </div>

    
        <aside class="page-aside">
            <div class="post-toc-wrap">
    <div class="post-toc">
        <ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E6%96%87%E4%BB%B6%E7%BB%93%E6%9E%84"><span class="nav-text">配置文件结构</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#location%E7%9A%84%E5%8C%B9%E9%85%8D"><span class="nav-text">location的匹配</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%B8%B8%E7%94%A8%E5%85%A8%E5%B1%80%E5%8F%98%E9%87%8F"><span class="nav-text">常用全局变量</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E9%85%8D%E7%BD%AE"><span class="nav-text">缓存配置</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%85%8D%E7%BD%AE%E7%BC%93%E5%AD%98%E6%97%B6%E9%97%B4"><span class="nav-text">配置缓存时间</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BD%BF%E7%94%A8%E5%8D%8F%E5%95%86%E7%BC%93%E5%AD%98"><span class="nav-text">使用协商缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%A6%81%E6%AD%A2%E7%BC%93%E5%AD%98"><span class="nav-text">禁止缓存</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E7%BC%93%E5%AD%98%E7%9B%B8%E5%85%B3%E6%A0%87%E8%AF%86"><span class="nav-text">缓存相关标识</span></a><ol class="nav-child"><li class="nav-item nav-level-4"><a class="nav-link" href="#Etag"><span class="nav-text">Etag</span></a></li><li class="nav-item nav-level-4"><a class="nav-link" href="#%E6%96%87%E4%BB%B6%E5%AD%98%E5%82%A8"><span class="nav-text">文件存储</span></a><ol class="nav-child"><li class="nav-item nav-level-5"><a class="nav-link" href="#from-memory-cache"><span class="nav-text">from memory cache</span></a></li><li class="nav-item nav-level-5"><a class="nav-link" href="#from-disk-cache"><span class="nav-text">from disk cache</span></a></li></ol></li></ol></li><li class="nav-item nav-level-3"><a class="nav-link" href="#try-files"><span class="nav-text">try_files</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#pass-proxy-%E4%BB%A3%E7%90%86"><span class="nav-text">pass_proxy 代理</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%8D%E5%B8%A6%E6%96%9C%E6%9D%A0"><span class="nav-text">不带斜杠</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%B8%A6%E6%96%9C%E6%9D%A0"><span class="nav-text">带斜杠</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%AD%A3%E5%88%99%E5%8C%B9%E9%85%8D%E7%9A%84%E6%97%B6%E5%80%99%E4%B8%8D%E8%83%BD%E5%B8%A6%E6%96%9C%E6%9D%A0"><span class="nav-text">正则匹配的时候不能带斜杠</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%96%9C%E6%9D%A0%E5%90%8E%E9%9D%A2%E5%8A%A0%E8%B7%AF%E5%BE%84"><span class="nav-text">斜杠后面加路径</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%BB%A3%E7%90%86%E4%B9%8B%E5%89%8Drewrite"><span class="nav-text">代理之前rewrite</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#gzip"><span class="nav-text">gzip</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8C%87%E5%AE%9A%E9%9C%80%E8%A6%81-gzip-%E7%9A%84%E6%96%87%E4%BB%B6"><span class="nav-text">指定需要 gzip 的文件</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%8E%8B%E7%BC%A9%E7%BA%A7%E5%88%AB"><span class="nav-text">压缩级别</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#gzip-static"><span class="nav-text">gzip_static</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B4%9F%E8%BD%BD%E5%9D%87%E8%A1%A1"><span class="nav-text">负载均衡</span></a></li></ol></li></ol>
    </div>
</div>
        </aside>
    

    <div class="image-viewer-container">
    <img src="">
</div>


    
        <div class="search-pop-overlay">
    <div class="popup search-popup">
        <div class="search-header">
          <span class="search-input-field-pre">
            <i class="fas fa-keyboard"></i>
          </span>
            <div class="search-input-container">
                <input autocomplete="off"
                       autocorrect="off"
                       autocapitalize="off"
                       placeholder="搜索..."
                       spellcheck="false"
                       type="search"
                       class="search-input"
                >
            </div>
            <span class="popup-btn-close">
                <i class="fas fa-times"></i>
            </span>
        </div>
        <div id="search-result">
            <div id="no-result">
                <i class="fas fa-spinner fa-pulse fa-5x fa-fw"></i>
            </div>
        </div>
    </div>
</div>

    

</main>




<script src="/js/utils.js"></script>

<script src="/js/main.js"></script>

<script src="/js/header-shrink.js"></script>

<script src="/js/back2top.js"></script>

<script src="/js/dark-light-toggle.js"></script>



    
<script src="/js/local-search.js"></script>




    
<script src="/js/code-copy.js"></script>




    
<script src="/js/lazyload.js"></script>



<div class="post-scripts pjax">
    
        
<script src="/js/left-side-toggle.js"></script>

<script src="/js/libs/anime.min.js"></script>

<script src="/js/toc.js"></script>

    
</div>


    
<script src="/js/libs/pjax.min.js"></script>

<script>
    window.addEventListener('DOMContentLoaded', () => {
        window.pjax = new Pjax({
            selectors: [
                'head title',
                '.page-container',
                '.pjax'
            ],
            history: true,
            debug: false,
            cacheBust: false,
            timeout: 0,
            analytics: false,
            currentUrlFullReload: false,
            scrollRestoration: false,
            // scrollTo: true,
        });

        document.addEventListener('pjax:send', () => {
            KEEP.utils.pjaxProgressBarStart();
        });

        document.addEventListener('pjax:complete', () => {
            KEEP.utils.pjaxProgressBarEnd();
            window.pjax.executeScripts(document.querySelectorAll('script[data-pjax], .pjax script'));
            KEEP.refresh();
        });
    });
</script>



<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"pluginModelPath":"assets/","model":{"jsonPath":"/live2dw/assets/hijiki.model.json"},"display":{"position":"right","width":200,"height":300},"mobile":{"show":true},"log":false,"pluginJsPath":"lib/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
